---
title: "Group17_code"
output:
  pdf_document: default
  html_document: default
date: "2024-03-13"
---

```{r setup, include=FALSE}
library(readr)
library(RSQLite)
library(dplyr)
library(DBI)
```

```{r}
all_files <- list.files("Dataset/")
all_files
```


```{r block2,attr.source='.numberLines'}
prefix <- "hi_"
suffix <- "_dataset.csv"

all_files <- gsub("hi_","",all_files)
all_files <- gsub("_dataset.csv","",all_files)
all_files

```

# Looping through - for 
Check number of rows and columns

```{r loop,message=FALSE,warning=FALSE,attr.source='.numberLines'}
all_files <- list.files("Dataset/")

for (variable in all_files) {
  this_filepath <- paste0("Dataset/",variable)
  this_file_contents <- readr::read_csv(this_filepath)
  
  number_of_rows <- nrow(this_file_contents)
  number_of_columns <- ncol(this_file_contents)
  
  print(paste0("The file: ",variable,
              " has: ",
              format(number_of_rows,big.mark = ","),
              " rows and ",
              number_of_columns," columns"))
}
```

#Check the data structure
```{r loop1,message=FALSE,warning=FALSE,attr.source='.numberLines'}
all_files <- list.files("Dataset/")

for (variable in all_files) {
  this_filepath <- paste0("Dataset/",variable)
  this_file_contents <- readr::read_csv(this_filepath)
  data_structure<-str(this_file_contents)
  
  print(paste0(data_structure,
               "The file: ",variable,
              " has above data structure"))
}
```
#Check for NULL values
```{r loop2,message=FALSE,warning=FALSE,attr.source='.numberLines'}
all_files <- list.files("data_upload/")

for (variable in all_files) {
  this_filepath <- paste0("data_upload/",variable)
  this_file_contents <- readr::read_csv(this_filepath)
  null<-sum(is.na(this_file_contents))
  
  print(paste0("The file: ",variable,
              " has a total of ", null,
              " NULL values"))
}
```

#Check that each primary key is unique in each table
```{r loop3,message=FALSE,warning=FALSE,attr.source='.numberLines'}
all_files <- list.files("Dataset/")

for (variable in all_files) {
  this_filepath <- paste0("Dataset/",variable)
  this_file_contents <- readr::read_csv(this_filepath)
  hi <- nrow(unique(this_file_contents[,1]))== nrow(this_file_contents)
  
  print(paste0("The file: ",variable,
              " has unique primary key ",
              hi," columns"))
}
```
For order dataset: we have a composite composed of 3 attribute, we'll check this one separately.
```{r getindividualvalues}
orderdate_dataset <- read.csv("Dataset/hi_orderdate_dataset.csv")
orderproductsinfo_dataset <- read.csv("Dataset/hi_orderproductsinfo_dataset.csv")
nrow(unique(orderdate_dataset[,1:3])) == nrow(orderdate_dataset)
nrow(unique(orderproductsinfo_dataset[,1:3])) == nrow(orderproductsinfo_dataset)
#sum(nrow(unique(orders[,1:2])))
#length((unique(orders$cutomer_id)))
#length((unique(orders$order_id)))
```
The file: hi_order_dataset.csv has unique primary composite key TRUE columns


# Load Files in an sqlite database 
```{r loadsqlite1,warning=FALSE,error=FALSE,message=FALSE,attr.source='.numberLines'}
#setup the connection
connection <- RSQLite::dbConnect(RSQLite::SQLite(),"hi_import.db")
```


1. product_category
```{sql connection=connection}
-- product_category
CREATE TABLE IF NOT EXISTS "product_category" ( 
  category_name VARCHAR(50) PRIMARY KEY,
  parent_category_id INT NULL
);
```

```{sql connection=connection}
SELECT * FROM "product_category";
```

2. promotion
```{sql connection=connection}
-- promotion
CREATE TABLE IF NOT EXISTS "promotion" ( 
  promo_code INT PRIMARY KEY, 
  promo_start_date DATE NULL,
  promo_expire_date DATE NULL,
  percentage_discount NUMERIC NOT NULL
  );

```

```{sql connection=connection}
SELECT * FROM "promotion";
```

3. supplier
```{sql connection=connection}
-- supplier
CREATE TABLE IF NOT EXISTS supplier ( 
  supplier_id INT PRIMARY KEY, 
  supplier_name CHAR NOT NULL,
  supplier_phone INT NOT NULL,
  supplier_email VARCHAR(50) NOT NULL,
  supplier_building INT NOT NULL,
  supplier_street VARCHAR(50) NOT NULL,
  supplier_city VARCHAR(50) NOT NULL,
  supplier_postcode VARCHAR(50) NOT NULL
) ; 
```


```{sql connection=connection}
SELECT * FROM "supplier";
```

4. customer
```{sql connection=connection}
-- customer
CREATE TABLE IF NOT EXISTS "customer" ( 
  customer_id INT PRIMARY KEY, 
  customer_firstname VARCHAR(50) NOT NULL,
  customer_lastname VARCHAR(50) NOT NULL,
  customer_title VARCHAR(25) NOT NULL, 
  customer_phone VARCHAR(50) NOT NULL,
  customer_email VARCHAR(50) NOT NULL,
  customer_membership TEXT NOT NULL, 
  delivery_fee NUMERIC NOT NULL,
  customer_building INT NOT NULL,
  customer_street VARCHAR(50) NOT NULL, 
  customer_city VARCHAR(50) NOT NULL, 
  customer_postcode VARCHAR(50) NOT NULL, 
  promo_code INT,
  FOREIGN KEY (promo_code) REFERENCES "promotion"(promo_code)
) ; 
```


```{sql connection=connection}
SELECT * FROM "customer";
```

5. delivery
```{sql connection=connection}
-- delivery
CREATE TABLE IF NOT EXISTS "delivery" ( 
  tracking_number INT PRIMARY KEY, 
  shipment_method VARCHAR(50) NOT NULL,
  tracking_status VARCHAR(50) NOT NULL,
  estimated_delivery_date DATE NOT NULL,
  estimated_delivery_time TIME NOT NULL,
  actual_delivery_date DATE NULL, 
  actual_delivery_time TIME NULL,
  delivery_instructions VARCHAR(125) NOT NULL,
  trans_id INT,
  FOREIGN KEY (trans_id) REFERENCES "transaction"(trans_id)
); 
```


```{sql connection=connection}
SELECT * FROM "delivery";
```

6. product
```{sql connection=connection}
-- product
CREATE TABLE IF NOT EXISTS "product" ( 
  product_id INT PRIMARY KEY, 
  product_name VARCHAR(25) NOT NULL,
  product_weight NUMERIC NOT NULL,
  product_length NUMERIC NOT NULL,
  product_height NUMERIC NOT NULL,
  product_width NUMERIC NOT NULL,
  product_price NUMERIC NOT NULL,
  supplier_id INT,
  category_name VARCHAR(50),
  FOREIGN KEY (supplier_id) REFERENCES "supplier"(supplier_id),
  FOREIGN KEY (category_name) REFERENCES "product_category"(category_name)
) ; 

```

```{sql connection=connection}
SELECT * FROM "product";
```


7. order
```{sql connection=connection}
-- order
CREATE TABLE IF NOT EXISTS "order" (
  customer_id INT,
  order_id INT,
  product_id INT,
  product_qty INT NOT NULL,
  order_date DATE NOT NULL, 
  order_time TIME NOT NULL,
  PRIMARY KEY (customer_id, order_id, product_id),
  FOREIGN KEY (customer_id) REFERENCES "customer"(customer_id),
  FOREIGN KEY (product_id) REFERENCES "product"(product_id)
) ; 
```


```{sql connection=connection}
SELECT * FROM "order";
```

8. transaction
```{sql connection=connection}
-- transaction
CREATE TABLE IF NOT EXISTS "transaction" (
  trans_id INT PRIMARY KEY,
  order_id INT,
  trans_date DATE NOT NULL,
  trans_time TIME NOT NULL,
  FOREIGN KEY (order_id) REFERENCES "order"(order_id)
);

```

```{sql connection=connection}
SELECT * FROM "transaction";
```



## Now normalize to 3NF
For customer
1. customer_basic_info
```{sql connection=connection}
-- customer_basic_info
CREATE TABLE IF NOT EXISTS "customer_basic_info" ( 
  customer_id INT PRIMARY KEY, 
  customer_firstname VARCHAR(50) NOT NULL,
  customer_lastname VARCHAR(50) NOT NULL,
  customer_title VARCHAR(25) NOT NULL, 
  customer_phone VARCHAR(50) NOT NULL,
  customer_email VARCHAR(50) NOT NULL,
  customer_building INT NOT NULL,
  customer_street VARCHAR(50) NOT NULL, 
  customer_city VARCHAR(50) NOT NULL, 
  customer_postcode VARCHAR(50) NOT NULL, 
  promo_code INT,
  FOREIGN KEY (promo_code) REFERENCES "promotion"(promo_code)
) ; 
```

```{sql connection=connection}
SELECT * FROM customer_basic_info
```

2. customer_membership
```{sql connection=connection}
-- customer_membership
CREATE TABLE IF NOT EXISTS "customer_memebership" ( 
  customer_id INT, 
  customer_membership TEXT, 
  delivery_fee NUMERIC NOT NULL,
  PRIMARY KEY (customer_id, customer_membership),
  FOREIGN KEY (customer_id) REFERENCES "customer_basic_info"(customer_id)
);
```

```{sql connection=connection}
SELECT * FROM customer_memebership
```

For order

1. order_products_info
```{sql connection=connection}
-- order_products_info
CREATE TABLE IF NOT EXISTS "order_products_info" (
  customer_id INT,
  order_id INT,
  product_id INT,
  product_qty INT NOT NULL,
  PRIMARY KEY (customer_id, order_id, product_id),
  FOREIGN KEY (customer_id) REFERENCES "customer_basic_info"(customer_id),
  FOREIGN KEY (product_id) REFERENCES "product"(product_id)
) ; 
```

```{sql connection=connection}
SELECT * FROM order_products_info
```

2. order_datetime
```{sql connection=connection}
-- order_datetime
CREATE TABLE IF NOT EXISTS "order_datetime" (
  customer_id INT,
  order_id INT,
  order_date DATE NOT NULL, 
  order_time TIME NOT NULL,
  PRIMARY KEY (customer_id, order_id),
  FOREIGN KEY (customer_id) REFERENCES "customer_basic_info"(customer_id)
) ; 
```

```{sql connection=connection}
SELECT * FROM order_datetime
```


For Delivery
1. delivery_tracking
```{sql connection=connection}
-- delivery_tracking
CREATE TABLE IF NOT EXISTS "delivery_tracking" ( 
  tracking_number INT PRIMARY KEY, 
  delivery_instructions VARCHAR(125) NOT NULL,
  trans_id INT,
  FOREIGN KEY (trans_id) REFERENCES "transaction"(trans_id)
); 
```

```{sql connection=connection}
SELECT * FROM delivery_tracking
```

2. estimated_delivery_date
```{sql connection=connection}
-- estimated_delivery_date
CREATE TABLE IF NOT EXISTS "estimated_delivery_date" ( 
  tracking_number INT, 
  shipment_method VARCHAR(50),
  estimated_delivery_date DATE NOT NULL,
  estimated_delivery_time TIME NOT NULL,
  PRIMARY KEY (tracking_number, shipment_method),
  FOREIGN KEY (tracking_number) REFERENCES "delivery_tracking"(tracking_number)
); 
```

```{sql connection=connection}
SELECT * FROM estimated_delivery_date
```

3. actual_delivery_date
```{sql connection=connection}
-- actual_delivery_date
CREATE TABLE IF NOT EXISTS "actual_delivery_date" ( 
  tracking_number INT, 
  tracking_status VARCHAR(50),
  actual_delivery_date DATE NULL, 
  actual_delivery_time TIME NULL,
  PRIMARY KEY (tracking_number, tracking_status),
  FOREIGN KEY (tracking_number) REFERENCES "delivery_tracking"(tracking_number)
); 
```

```{sql connection=connection}
SELECT * FROM actual_delivery_date
```

```{r}
# Read datasets
#order
orderdate_dataset <- read.csv("Dataset/hi_orderdate_dataset.csv",row.names = NULL)
orderproductsinfo_dataset <- read.csv("Dataset/hi_orderproductsinfo_dataset.csv",row.names = NULL)

#delivery
actualdeliverydate_dataset <- read.csv("Dataset/hi_actualdeliverydate_dataset.csv",row.names = NULL)
trackingnumber_dataset <- read.csv("Dataset/hi_trackingnumber_dataset.csv",row.names = NULL)
estimateddeliverydate_dataset <- read.csv("Dataset/hi_estimateddeliverydate_dataset.csv",row.names = NULL)

#customer
hi_customerbasicinfo_dataset <- read.csv("Dataset/hi_customerbasicinfo_dataset.csv",row.names = NULL)
membership_dataset <- read.csv("Dataset/hi_membership_dataset.csv",row.names = NULL)

product_dataset <- read.csv("Dataset/hi_product_dataset.csv",row.names = NULL)
productcategory_dataset <- read.csv("Dataset/hi_productcategory_dataset.csv",row.names = NULL)
promotion_dataset <- read.csv("Dataset/hi_promotion_dataset.csv",row.names = NULL)
supplier_dataset <- read.csv("Dataset/hi_supplier_dataset.csv",row.names = NULL)
transaction_dataset <- read.csv("Dataset/hi_transaction_dataset.csv",row.names = NULL)
```

```{r loadsqlite5,warning=FALSE,error=FALSE,message=FALSE,attr.source='.numberLines'}
dbWriteTable(connection, "product", product_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "product_category", productcategory_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "promotion", promotion_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "supplier", supplier_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "transaction", transaction_dataset, append = TRUE, row.names = FALSE)

#order
dbWriteTable(connection, "order_datetime", orderdate_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "order_products_info", orderproductsinfo_dataset, append = TRUE, row.names = FALSE)

#delivery
dbWriteTable(connection, "actual_delivery_date", actualdeliverydate_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "delivery_tracking", trackingnumber_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "estimated_delivery_date", estimateddeliverydate_dataset, append = TRUE, row.names = FALSE)

#customer
dbWriteTable(connection, "customer_memebership", membership_dataset, append = TRUE, row.names = FALSE)
dbWriteTable(connection, "customer_basic_info", hi_customerbasicinfo_dataset, append = TRUE, row.names = FALSE)
```


```{r listtables}
RSQLite::dbListTables(connection)
```

```{r disconnect}
RSQLite::dbDisconnect(connection)
```

